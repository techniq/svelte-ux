<script lang="ts">
  import type { ComponentProps, Snippet } from 'svelte';

  import Icon from './Icon.svelte';
  import { getSteps } from './Steps.svelte';
  import { getComponentClasses } from './theme.js';
  import { cls } from '../utils/styles.js';

  interface Props {
    /** Override point content (by default uses an incrementing counter) */
    point?: string | Snippet;
    /** Use icon instead of point content */
    icon?: ComponentProps<typeof Icon>['data'];
    /** If completed, will color content and line leading up to item */
    completed?: boolean;
    classes?: {
      root?: string;
      label?: string;
      line?: string;
      point?: string;
      /** Apply classes to completed item point and line leading up to item */
      completed?: string;
    };
    class?: string;
    children?: Snippet;
  }

  let {
    point,
    icon,
    completed = false,
    classes = {},
    class: className,
    children,
  }: Props = $props();
  const settingsClasses = getComponentClasses('Step');

  const stepsContext = getSteps();
  let vertical = $derived(stepsContext?.vertical ?? false);
</script>

<li
  class={cls(
    'Step',
    'group grid place-items-center text-center',
    vertical
      ? 'grid-cols-[40px_1fr] gap-2 min-h-16 justify-items-start'
      : 'grid-rows-[40px_1fr] min-w-16',
    settingsClasses.root,
    classes.root,
    className
  )}
>
  <div
    class={cls(
      'group-first:hidden col-start-1 row-start-1 bg-surface-300 text-surface-content top-0',
      vertical ? 'h-full w-2 -mt-[100%] justify-self-center' : 'h-2 w-full -ml-[100%]',
      completed && (settingsClasses.completed ?? classes.completed ?? 'bg-primary'),
      settingsClasses.line,
      classes.line
    )}
  ></div>

  <span class={cls(settingsClasses.label, classes.label)}>
    {@render children?.()}
  </span>

  <div
    class={cls(
      'bg-surface-300 text-surface-content relative col-start-1 row-start-1 grid size-8 place-items-center place-self-center rounded-full [counter-increment:step]',
      point == null && icon == null && 'before:content-[counter(step)]',
      completed &&
        (settingsClasses.completed ?? classes.completed ?? 'bg-primary text-primary-content'),
      settingsClasses.point,
      classes.point
    )}
  >
    {#if typeof point === 'function'}
      {@render point()}
    {:else if icon}
      <Icon data={icon} />
    {:else}
      {point ?? ''}
    {/if}
  </div>
</li>
